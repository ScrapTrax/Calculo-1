<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Derivada Paso a Paso</title>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; max-width: 900px; margin: auto; }
    .container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    h1 { text-align: center; color: #333; }
    label, input, button { display: block; margin: 10px 0; font-size: 16px; }
    input { width: 100%; padding: 10px; }
    button { background: #007BFF; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #steps, #result { background: #f0f9ff; padding: 20px; margin-top: 20px; border-left: 5px solid #007BFF; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Derivada por Método del Límite</h1>
    <label for="funcion">Ingresa una función polinómica (Ej: 3x^2 + 2x + 1):</label>
    <input id="funcion" type="text" placeholder="Ejemplo: x^2 + 3x + 2">
    <button onclick="resolverDerivada()">Resolver</button>

    <div id="steps"></div>
    <div id="result"></div>
  </div>

  <script>
    function parsePolinomio(fx) {
      fx = fx.replace(/\s+/g, '').replace(/-/g, '+-');
      const terminos = fx.split('+').filter(Boolean);
      return terminos.map(t => {
        if (t.includes('x')) {
          const [coef, exp] = t.split('x^').length > 1
            ? [t.split('x^')[0], t.split('x^')[1]]
            : [t.replace('x', ''), 1];
          return {
            coef: coef === '' || coef === '+' ? 1 : (coef === '-' ? -1 : parseFloat(coef)),
            exp: parseInt(exp || 1)
          };
        } else {
          return { coef: parseFloat(t), exp: 0 };
        }
      });
    }

    function expandBinomio(termino) {
      const { coef, exp } = termino;
      let expansion = [];
      for (let k = 0; k <= exp; k++) {
        const binomial = factorial(exp) / (factorial(k) * factorial(exp - k));
        const c = coef * binomial;
        const xPow = exp - k;
        const hPow = k;
        let part = '';
        if (c !== 0) {
          if (xPow > 0) part += `x${xPow > 1 ? '^' + xPow : ''}`;
          if (hPow > 0) part += `h${hPow > 1 ? '^' + hPow : ''}`;
          if (xPow === 0 && hPow === 0) part += '1';
          expansion.push((c === 1 ? '' : c) + part);
        }
      }
      return expansion.join(' + ');
    }

    function factorial(n) {
      return n <= 1 ? 1 : n * factorial(n - 1);
    }

    function resolverDerivada() {
      const fx = document.getElementById("funcion").value;
      const pasosDiv = document.getElementById("steps");
      const resultDiv = document.getElementById("result");

      try {
        const terminos = parsePolinomio(fx);
        let fxh_parts = [];
        let fx_parts = [];

        let pasos = `
          <h2>1. Aplicamos la fórmula del límite:</h2>
          $$f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$
          <h2>2. Expandimos cada término de f(x + h):</h2>
        `;

        terminos.forEach((t, i) => {
          const expansion = expandBinomio(t);
          fxh_parts.push(expansion);
          fx_parts.push(`${t.coef !== 1 ? t.coef : ''}x${t.exp > 1 ? '^' + t.exp : (t.exp === 1 ? '' : '')}`);
          pasos += `
            <p>Término ${i + 1}: $$${t.coef !== 1 ? t.coef : ''}x^${t.exp}$$</p>
            <p>Expandimos:</p>
            $$${t.coef}(x + h)^${t.exp} = ${expansion}$$
          `;
        });

        const fxh = fxh_parts.join(' + ').replace(/\+\s\-/g, '- ');
        const fxNormal = fx_parts.join(' + ').replace(/\+\s\-/g, '- ');

        pasos += `
          <h2>3. Sustituimos en la fórmula:</h2>
          $$\\frac{(${fxh}) - (${fxNormal})}{h}$$
        `;

        // Simplificar: cancelar términos con x^n (los f(x))
        const cancelados = fx_parts;
        let numerador = fxh_parts.join(' + ');
        cancelados.forEach(c => {
          numerador = numerador.replace(c, '');
        });

        pasos += `
          <h2>4. Cancelamos los términos comunes y simplificamos:</h2>
          $$\\frac{${numerador}}{h}$$
        `;

        // Dividir cada término entre h
        const divididos = numerador.split('+').map(t => t.trim()).filter(Boolean).map(term => {
          return `\\frac{${term}}{h}`;
        });

        pasos += `
          <h2>5. Dividimos cada término por h:</h2>
          $$${divididos.join(' + ')}$$
        `;

        const resultadoFinal = divididos.map(frac => {
          return frac.replace(/\\frac{(.+?)h(\^\d+)?}{h}/, (_, x, hExp) => {
            if (!hExp) return x;
            const power = parseInt(hExp.replace('^', ''));
            if (power === 2) return x + 'h';
            if (power > 2) return x + 'h^' + (power - 1);
            return x;
          });
        }).filter(t => !t.includes('h')).join(' + ').replace(/\+\s\-/g, '- ');

        pasos += `
          <h2>6. Tomamos el límite cuando h → 0 (se anulan los términos con h):</h2>
          $$f'(x) = ${resultadoFinal || '0'}$$
        `;

        pasosDiv.innerHTML = pasos;
        resultDiv.innerHTML = `<h2>Resultado Final</h2><p>$$f'(x) = ${resultadoFinal || '0'}$$</p>`;
        MathJax.typeset();
      } catch (err) {
        pasosDiv.innerHTML = 'Error en el formato de la función. Usa solo funciones polinómicas como `x^2 + 2x + 1`.';
        resultDiv.innerHTML = '';
      }
    }
  </script>
</body>
</html>
