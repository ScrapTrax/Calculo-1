<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Derivadas (Límite del Cociente de Diferencias)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 2rem auto;
    padding: 1rem;
    background: #f0f4f8;
    color: #222;
  }
  h1 {
    text-align: center;
    color: #004e89;
  }
  label {
    font-weight: bold;
    margin-top: 1rem;
    display: block;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    font-size: 1.1rem;
    padding: 0.5rem;
    margin-top: 0.3rem;
    box-sizing: border-box;
  }
  button {
    margin-top: 1rem;
    padding: 0.7rem 1.5rem;
    font-size: 1.1rem;
    background-color: #0077cc;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }
  button:hover {
    background-color: #005fa3;
  }
  #output {
    margin-top: 2rem;
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  }
  pre {
    background: #eee;
    padding: 0.8rem;
    border-radius: 4px;
    overflow-x: auto;
  }
  #plot {
    margin-top: 2rem;
  }
  .explanation {
    margin-top: 1rem;
    line-height: 1.4;
  }
</style>
</head>
<body>

<h1>Calculadora de Derivadas por Límite del Cociente de Diferencias</h1>

<form id="derivForm">
  <label for="funcInput">Función \( f(x) \) (usa sintaxis JavaScript Math, ejemplo: x*x + 3*x, Math.sin(x), Math.log(x)):</label>
  <input type="text" id="funcInput" placeholder="Ejemplo: x*x + 3*x" required />

  <label for="xValue">Punto donde calcular la derivada (valor de \( x \)):</label>
  <input type="number" id="xValue" value="1" step="any" required />

  <button type="submit">Calcular Derivada</button>
</form>

<div id="output"></div>
<div id="plot"></div>

<!-- Plotly CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  // Función para evaluar la función ingresada de forma segura
  function evalFunction(funcStr, x) {
    // Creamos una función con "x" en el contexto
    try {
      // Evitar usar eval directamente: new Function is safer here
      const f = new Function("x", "return " + funcStr + ";");
      const val = f(x);
      if (typeof val !== "number" || isNaN(val) || !isFinite(val)) {
        throw new Error("El resultado no es un número válido.");
      }
      return val;
    } catch (e) {
      throw new Error("Error al evaluar la función: " + e.message);
    }
  }

  document.getElementById("derivForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const funcStr = document.getElementById("funcInput").value.trim();
    const x = parseFloat(document.getElementById("xValue").value);
    const outputDiv = document.getElementById("output");
    const plotDiv = document.getElementById("plot");
    outputDiv.innerHTML = "";
    plotDiv.innerHTML = "";

    // Validar inputs
    if (!funcStr) {
      outputDiv.textContent = "Por favor ingresa una función válida.";
      return;
    }
    if (isNaN(x)) {
      outputDiv.textContent = "Por favor ingresa un valor numérico para x.";
      return;
    }

    // Pasos del cálculo
    // Usaremos aproximaciones con h cada vez más pequeño y el cociente de diferencias centradas:
    // f'(x) ~ (f(x+h) - f(x-h)) / (2h)
    // para h = 0.1, 0.01, 0.001, 0.0001

    let steps = [];
    const hValues = [0.1, 0.01, 0.001, 0.0001, 0.00001];
    let derivApprox = null;

    try {
      for (let h of hValues) {
        const fxh = evalFunction(funcStr, x + h);
        const fx_h = evalFunction(funcStr, x - h);
        const diffQuot = (fxh - fx_h) / (2 * h);
        steps.push({ h, fxh, fx_h, diffQuot });
        derivApprox = diffQuot; // Última aproximación (más pequeña h)
      }
    } catch (error) {
      outputDiv.textContent = error.message;
      return;
    }

    // Mostrar cálculo paso a paso
    let html = `<h2>Cálculo paso a paso usando el límite del cociente de diferencias centradas:</h2>`;
    html += `<p>Queremos calcular:</p>`;
    html += `<p style="font-size:1.2em; font-weight:bold;">f'(x) = lim (h→0) [f(x+h) - f(x-h)] / (2h)</p>`;
    html += `<p>En el punto x = <b>${x}</b>:</p>`;

    html += `<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; margin: 1rem 0; width:100%; max-width:700px;">
      <thead>
        <tr style="background:#0077cc; color:white;">
          <th>h</th>
          <th>f(x+h)</th>
          <th>f(x-h)</th>
          <th>Derivada Aproximada = [f(x+h) - f(x-h)] / 2h</th>
        </tr>
      </thead><tbody>`;

    for (let step of steps) {
      html += `<tr>
        <td>${step.h}</td>
        <td>${step.fxh.toFixed(6)}</td>
        <td>${step.fx_h.toFixed(6)}</td>
        <td>${step.diffQuot.toFixed(6)}</td>
      </tr>`;
    }
    html += `</tbody></table>`;

    html += `<p><b>Valor aproximado de la derivada en x = ${x}:</b> ${derivApprox.toFixed(6)}</p>`;

    // Explicación del método
    html += `<div class="explanation">
      <h3>Explicación:</h3>
      <p>La derivada de una función en un punto representa la pendiente de la recta tangente en ese punto.</p>
      <p>Usamos el <b>cociente de diferencias centradas</b> para aproximar el límite que define la derivada. Este método es más preciso que usar diferencias hacia adelante o hacia atrás.</p>
      <p>Al disminuir el valor de <i>h</i>, la aproximación mejora, y vemos la convergencia hacia el valor real de la derivada.</p>
    </div>`;

    outputDiv.innerHTML = html;

    // Ahora graficamos la función y la tangente en el punto x

    // Crear datos para graficar f(x) en un intervalo cercano a x
    const xValues = [];
    const yValues = [];
    const stepPlot = 0.01;
    const range = 2; // Graficar x ± range

    for (let xi = x - range; xi <= x + range; xi += stepPlot) {
      try {
        xValues.push(xi);
        yValues.push(evalFunction(funcStr, xi));
      } catch {
        yValues.push(null);
      }
    }

    // Recta tangente: y = f(x0) + f'(x0)(x - x0)
    const fx0 = evalFunction(funcStr, x);
    const tangentY = xValues.map((xi) => fx0 + derivApprox * (xi - x));

    // Plotly data
    const data = [
      {
        x: xValues,
        y: yValues,
        mode: "lines",
        name: "f(x)",
        line: { color: "#0077cc", width: 3 },
      },
      {
        x: xValues,
        y: tangentY,
        mode: "lines",
        name: `Recta tangente en x = ${x}`,
        line: { color: "#ff6600", width: 2, dash: "dash" },
      },
      {
        x: [x],
        y: [fx0],
        mode: "markers",
        name: "Punto de tangencia",
        marker: { color: "red", size: 8 },
      },
    ];

    const layout = {
      title: "Gráfica de la función y la recta tangente en el punto",
      xaxis: { title: "x", zeroline: true },
      yaxis: { title: "y" },
      showlegend: true,
      margin: { t: 50, r: 30, b: 50, l: 60 },
    };

    Plotly.newPlot("plot", data, layout, { responsive: true });
  });
</script>

</body>
</html>
