<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Derivadas por Cociente de Diferencias al Cuadrado</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px; 
    background: #f0f4f8;
    color: #222;
  }
  h1 {
    text-align: center;
    color: #0057b8;
  }
  label, input, button {
    font-size: 1.1rem;
  }
  input {
    width: 300px;
    padding: 8px;
    margin: 10px 0 20px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    background-color: #0057b8;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background-color: #003f7d;
  }
  #resultado, #explicacion {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  #grafica {
    margin-top: 30px;
  }
</style>
</head>
<body>

<h1>Calculadora de Derivadas: Cociente de Diferencias al Cuadrado</h1>

<label for="funcion">Ingresa la función f(x):</label><br/>
<input type="text" id="funcion" placeholder="Ejemplo: x^2 + 3*x - 5, sin(x), ln(x)" />
<br/>
<label for="punto">Derivar en x = </label>
<input type="number" id="punto" value="1" step="0.01" />
<br/>
<button onclick="calcularDerivada()">Calcular Derivada</button>

<div id="resultado"></div>
<div id="explicacion"></div>
<div id="grafica"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  // Función para evaluar expresiones matemáticas seguras usando math.js (podemos usar con eval pero es riesgoso)
  // En este ejemplo simplificado usaré Function() para evaluar, con validación básica.

  function evaluarFuncion(expr, x) {
    try {
      // Reemplazar potencias: x^2 -> Math.pow(x,2)
      expr = expr.replace(/\^/g, "**");

      // Crear función segura con Math y Math.* funciones
      // Solo permitir letras, números, +-/*^(). y funciones básicas
      // Vamos a usar new Function para mayor flexibilidad (sin eval)
      let f = new Function("x", "with(Math) { return " + expr + "; }");
      return f(x);
    } catch (error) {
      return NaN;
    }
  }

  function calcularDerivada() {
    const funcionInput = document.getElementById("funcion").value.trim();
    const x0 = parseFloat(document.getElementById("punto").value);
    const h = 0.0001; // pequeño para aproximar límite

    const resultadoDiv = document.getElementById("resultado");
    const explicacionDiv = document.getElementById("explicacion");
    const graficaDiv = document.getElementById("grafica");

    if (!funcionInput) {
      alert("Por favor ingresa una función válida.");
      return;
    }
    if (isNaN(x0)) {
      alert("Por favor ingresa un valor numérico para x.");
      return;
    }

    // Evaluar f(x0 + h), f(x0 - h)
    const fxh = evaluarFuncion(funcionInput, x0 + h);
    const fxnh = evaluarFuncion(funcionInput, x0 - h);
    const fx = evaluarFuncion(funcionInput, x0);

    if ([fx, fxh, fxnh].some(v => isNaN(v) || !isFinite(v))) {
      resultadoDiv.innerHTML = "<b>Error:</b> La función no se pudo evaluar en ese punto. Verifica la expresión.";
      explicacionDiv.innerHTML = "";
      graficaDiv.innerHTML = "";
      return;
    }

    // Calcular derivada aproximada
    const derivadaAprox = (fxh - fxnh) / (2 * h);

    // Mostrar resultado y explicación paso a paso
    resultadoDiv.innerHTML = `<h2>Resultado</h2>
      <p>Derivada aproximada de <b>f(x)</b> en <b>x = ${x0}</b> usando el cociente de diferencias al cuadrado:</p>
      <p style="font-size:1.3em; color:#007acc;">
      f'(${x0}) ≈ [f(${x0} + h) - f(${x0} - h)] / (2h) = (${fxh.toFixed(6)} - ${fxnh.toFixed(6)}) / (2 × ${h}) = <b>${derivadaAprox.toFixed(6)}</b>
      </p>`;

    explicacionDiv.innerHTML = `<h3>Explicación del Método</h3>
      <p>La derivada de una función en un punto se define como el límite cuando <b>h</b> tiende a cero de la tasa de cambio:</p>
      <p style="font-style: italic;">
      f'(x) = lim<sub>h→0</sub> [f(x + h) - f(x - h)] / (2h)
      </p>
      <p>En lugar de usar solo <code>(f(x+h) - f(x)) / h</code>, usamos esta fórmula simétrica para obtener mejor precisión numérica.</p>
      <p>Usamos un valor pequeño de <b>h = ${h}</b> para aproximar este límite.</p>`;

    // Graficar la función y su derivada aproximada
    graficar(funcionInput, x0, derivadaAprox);
  }

  function graficar(funcion, x0, derivadaAprox) {
    const graficaDiv = document.getElementById("grafica");

    // Crear array de x para graficar en rango [x0-5, x0+5]
    let xs = [];
    let ys = [];
    let ysDeriv = [];

    const h = 0.0001;

    for (let i = x0 - 5; i <= x0 + 5; i += 0.1) {
      xs.push(i);
      ys.push(evaluarFuncion(funcion, i));
      // derivada aproximada por cociente de diferencias
      let f_xph = evaluarFuncion(funcion, i + h);
      let f_xmh = evaluarFuncion(funcion, i - h);
      let d_approx = (f_xph - f_xmh) / (2 * h);
      ysDeriv.push(d_approx);
    }

    // Punto para marcar derivada exacta aproximada en x0
    const fx0 = evaluarFuncion(funcion, x0);

    var data = [
      {
        x: xs,
        y: ys,
        type: 'scatter',
        mode: 'lines',
        name: 'f(x)',
        line: {color: 'blue'}
      },
      {
        x: xs,
        y: ysDeriv,
        type: 'scatter',
        mode: 'lines',
        name: "f'(x) aproximada",
        line: {color: 'red', dash: 'dash'}
      },
      {
        x: [x0],
        y: [fx0],
        mode: 'markers',
        name: `Punto x=${x0}`,
        marker: {color: 'green', size: 10}
      },
      {
        x: [x0],
        y: [derivadaAprox],
        mode: 'markers',
        name: `Derivada aprox en x=${x0}`,
        marker: {color: 'orange', size: 10, symbol: 'star'}
      }
    ];

    var layout = {
      title: 'Gráfica de f(x) y su derivada aproximada',
      xaxis: {title: 'x'},
      yaxis: {title: 'y'},
      legend: {x: 0, y: 1},
      annotations: [
        {
          x: x0,
          y: fx0,
          xref: 'x',
          yref: 'y',
          text: `f(${x0}) = ${fx0.toFixed(3)}`,
          showarrow: true,
          arrowhead: 6,
          ax: -40,
          ay: -40
        },
        {
          x: x0,
          y: derivadaAprox,
          xref: 'x',
          yref: 'y',
          text: `f'(${x0}) ≈ ${derivadaAprox.toFixed(3)}`,
          showarrow: true,
          arrowhead: 6,
          ax: 40,
          ay: 40
        }
      ]
    };

    Plotly.newPlot(graficaDiv, data, layout, {responsive: true});
  }
</script>

</body>
</html>
