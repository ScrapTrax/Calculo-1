function calcularDerivada() 
  const fInput = document.getElementById('func').value.trim();
  const x0 = parseFloat(document.getElementById('x0').value);
  const resultadoDiv = document.getElementById('resultado');
  const stepsDiv = document.getElementById('steps');

  if (!fInput) {
    alert('Por favor ingrese una función válida.');
    return;
  }
  if (isNaN(x0)) {
    alert('Por favor ingrese un número válido para x₀.');
    return;
  }

  const fStr = parseFunction(fInput);

  let fEval;
  try {
    fEval = math.compile(fStr);
    fEval.evaluate({ x: x0 });
  } catch (e) {
    alert('Error en la función ingresada. Revisa la sintaxis.');
    return;
  }

  // Método largo: cociente de diferencias centrado
  const hs = [0.01, 0.005, 0.0025, 0.00125]; // h estables
  let pasosTexto = `Función: f(x) = ${fInput}\nPunto de derivación: x₀ = ${x0}\n\n`;
  pasosTexto += "Método largo:\n";
  pasosTexto += "f'(x₀) ≈ [f(x₀ + h) - f(x₀ - h)] / (2h)\n\n";

  let sumaDerivadas = 0;
  let derivadasAprox = [];

  hs.forEach((h, i) => {
    const fxph = fEval.evaluate({ x: x0 + h });
    const fxmh = fEval.evaluate({ x: x0 - h });
    const deriv = (fxph - fxmh) / (2 * h);
    derivadasAprox.push(deriv);
    sumaDerivadas += deriv;

    pasosTexto += `Paso ${i + 1}: h = ${h}\n`;
    pasosTexto += `f(${x0} + ${h}) = ${fxph.toFixed(8)}\n`;
    pasosTexto += `f(${x0} - ${h}) = ${fxmh.toFixed(8)}\n`;
    pasosTexto += `Aproximación = (${fxph.toFixed(8)} - ${fxmh.toFixed(8)}) / (${2 * h}) = ${deriv.toFixed(8)}\n\n`;
  });

  const derivadaLarga = sumaDerivadas / hs.length;

  // Derivada simbólica
  let derivadaSimbolicaStr;
  let derivadaSimbolica;
  try {
    const node = math.parse(fStr);
    const derivNode = math.derivative(node, 'x');
    derivadaSimbolicaStr = derivNode.toString();
    derivadaSimbolica = derivNode.evaluate({ x: x0 });
  } catch (e) {
    derivadaSimbolicaStr = "Error al derivar simbólicamente.";
    derivadaSimbolica = NaN;
  }

  pasosTexto += `Método corto:\n`;
  pasosTexto += `f'(x) = ${derivadaSimbolicaStr}\n`;
  pasosTexto += `f'(${x0}) = ${derivadaSimbolica?.toFixed(8)}\n\n`;

  const diferencia = Math.abs(derivadaLarga - derivadaSimbolica);

  pasosTexto += `Comparación:\n`;
  pasosTexto += `Método largo ≈ ${derivadaLarga.toFixed(8)}\n`;
  pasosTexto += `Método corto ≈ ${derivadaSimbolica.toFixed(8)}\n`;
  pasosTexto += `Diferencia absoluta = ${diferencia.toExponential(2)}\n`;

  if (diferencia < 1e-4) {
    pasosTexto += "\n✅ Ambos métodos coinciden correctamente.";
  } else {
    pasosTexto += "\n⚠️ Existe una diferencia notable. Revisa si la función es discontinua, no derivable o si requiere un punto válido en su dominio.";
  }

  resultadoDiv.innerHTML = `
    <b>Resultado final:</b><br>
    Derivada por límite ≈ <b>${derivadaLarga.toFixed(8)}</b><br>
    Derivada simbólica ≈ <b>${derivadaSimbolica.toFixed(8)}</b>
  `;
  stepsDiv.textContent = pasosTexto;

  graficarFuncionYDerivada(fEval, derivadaSimbolica, x0);
}
