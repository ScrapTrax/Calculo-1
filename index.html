<!-- Sigue usando tu mismo código base, pero reemplaza tu <script> con el siguiente -->

<script>
    function resolverDerivada() {
        const funcionStr = document.getElementById('funcionInput').value.trim();
        const resultadoDiv = document.getElementById('resultadoTexto');
        const explicacionDiv = document.getElementById('explanation');

        if (funcionStr === '') {
            resultadoDiv.innerHTML = 'Por favor, ingresa una función.';
            return;
        }

        try {
            const terminos = funcionStr.split('+').map(t => t.trim()).filter(t => t);
            let derivadaTerminos = [];
            let pasosExplicacion = '';

            terminos.forEach((termino, i) => {
                termino = termino.replace(/\s/g, '');
                let coef = 1, exp = 1;

                // Constantes: derivada 0
                if (!termino.includes('x')) {
                    pasosExplicacion += `
                        <h3>Término ${i+1}: ${termino}</h3>
                        <p>Este es un número constante, por lo tanto:</p>
                        $$\\frac{d}{dx}(${termino}) = 0$$
                    `;
                    return;
                }

                // Solo 'x'
                if (termino === 'x') {
                    coef = 1; exp = 1;
                }

                // ax
                else if (/^\d+x$/.test(termino)) {
                    coef = parseInt(termino);
                    exp = 1;
                }

                // x^n
                else if (/^x\^\d+$/.test(termino)) {
                    coef = 1;
                    exp = parseInt(termino.split('^')[1]);
                }

                // ax^n
                else if (/^\d+x\^\d+$/.test(termino)) {
                    coef = parseInt(termino.split('x')[0]);
                    exp = parseInt(termino.split('^')[1]);
                }

                // Si no se reconoce
                else {
                    throw new Error("Formato no reconocido.");
                }

                // Derivada con regla corta
                const nuevoCoef = coef * exp;
                const nuevoExp = exp - 1;
                if (nuevoExp === 0) {
                    derivadaTerminos.push(`${nuevoCoef}`);
                } else if (nuevoExp === 1) {
                    derivadaTerminos.push(`${nuevoCoef}x`);
                } else {
                    derivadaTerminos.push(`${nuevoCoef}x^${nuevoExp}`);
                }

                // Explicación paso a paso
                pasosExplicacion += `
                    <h3>Término ${i+1}: ${coef === 1 ? '' : coef}x^${exp}</h3>
                    <p>Usamos la fórmula del límite:</p>
                    $$f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$
                    <p>1. Calculamos \( f(x+h) \):</p>
                    $$f(x+h) = ${coef}(x+h)^${exp}$$
                    <p>2. Expandimos usando binomio:</p>
                    $$= ${expandirBinomio(coef, exp)}$$
                    <p>3. Sustituimos en la fórmula:</p>
                    $$\\frac{(${expandirBinomio(coef, exp)} - ${coef}x^${exp})}{h}$$
                    <p>4. Simplificamos y aplicamos el límite:</p>
                    $$\\Rightarrow ${nuevoCoef}${nuevoExp > 0 ? 'x' + (nuevoExp > 1 ? '^' + nuevoExp : '') : ''}$$
                `;
            });

            const derivadaFinal = derivadaTerminos.filter(t => t !== '0').join(' + ') || '0';

            resultadoDiv.innerHTML = `La derivada de $f(x) = ${funcionStr}$ es: <br> $$f'(x) = ${derivadaFinal}$$`;
            explicacionDiv.innerHTML = `
                <h2>1. Proceso de la Derivada por Límites (Método Largo)</h2>
                <p>Aplicamos el método del cociente de diferencias:</p>
                <p class="math-formula">$$f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$</p>
                ${pasosExplicacion}
            `;
            MathJax.typeset();
        } catch (e) {
            resultadoDiv.innerHTML = 'Error al procesar la función. Usa solo funciones polinómicas como `3x^2 + 2x + 1`.';

        }
    }

    function expandirBinomio(coef, exp) {
        if (exp === 0) return coef.toString();
        if (exp === 1) return `${coef}x + ${coef}h`;
        if (exp === 2) return `${coef}x^2 + ${2 * coef}xh + ${coef}h^2`;
        if (exp === 3) return `${coef}x^3 + ${3 * coef}x^2h + ${3 * coef}xh^2 + ${coef}h^3`;
        return `${coef}(x+h)^${exp}`;
    }
</script>
