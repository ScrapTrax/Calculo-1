<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Derivada por Límite (Paso a Paso)</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; max-width: 900px; margin: auto; }
    .container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    h1 { text-align: center; }
    label, input, button { display: block; margin: 10px 0; font-size: 16px; }
    input { width: 100%; padding: 10px; }
    button { background: #007BFF; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #steps, #result { background: #f0f9ff; padding: 20px; margin-top: 20px; border-left: 5px solid #007BFF; border-radius: 5px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Derivada por Método del Límite</h1>
  <label for="funcion">Función polinómica (ej: x^2 + 3x + 1):</label>
  <input id="funcion" type="text" placeholder="Ej: x^2 + 3x + 1">
  <button onclick="resolverDerivada()">Resolver</button>

  <div id="steps"></div>
  <div id="result"></div>
</div>

<script>
  function parsePolinomio(input) {
    input = input.replace(/\s+/g, '').replace(/-/g, '+-');
    const terminos = input.split('+').filter(Boolean);
    return terminos.map(t => {
      if (!t.includes('x')) return { coef: parseFloat(t), exp: 0 };
      let coef = 1, exp = 1;
      if (t.includes('x^')) {
        [coef, exp] = t.split('x^');
        coef = coef === '' ? 1 : (coef === '-' ? -1 : parseFloat(coef));
        exp = parseInt(exp);
      } else if (t.includes('x')) {
        coef = t.replace('x', '');
        coef = coef === '' ? 1 : (coef === '-' ? -1 : parseFloat(coef));
        exp = 1;
      }
      return { coef, exp };
    });
  }

  function expandBinomio(coef, exp) {
    const terms = [];
    for (let k = 0; k <= exp; k++) {
      const bin = factorial(exp) / (factorial(k) * factorial(exp - k));
      const c = coef * bin;
      const x = exp - k;
      const h = k;
      let term = (c === 1 ? '' : (c === -1 ? '-' : c));
      if (x > 0) term += `x${x > 1 ? '^' + x : ''}`;
      if (h > 0) term += `h${h > 1 ? '^' + h : ''}`;
      if (x === 0 && h === 0) term += '1';
      terms.push(term);
    }
    return terms;
  }

  function factorial(n) {
    return n <= 1 ? 1 : n * factorial(n - 1);
  }

  function simplificar(terms) {
    const mapa = {};
    for (let t of terms) {
      const match = t.match(/^(-?\d*\.?\d*)(x(\^\d+)?)?(h(\^\d+)?)?$/);
      if (!match) continue;
      let coef = match[1] === '' || match[1] === '+' ? 1 : (match[1] === '-' ? -1 : parseFloat(match[1]));
      const x = match[3] || '';
      const h = match[5] || '';
      const clave = `x${x || ''}h${h || ''}`;
      mapa[clave] = (mapa[clave] || 0) + coef;
    }
    const resultado = [];
    for (let [clave, coef] of Object.entries(mapa)) {
      if (coef === 0) continue;
      let parte = '';
      if (coef === 1) parte = '';
      else if (coef === -1) parte = '-';
      else parte = coef.toString();
      resultado.push(parte + clave.replace(/x1/g, 'x').replace(/h1/g, 'h'));
    }
    return resultado;
  }

  function resolverDerivada() {
    const input = document.getElementById("funcion").value;
    const pasosDiv = document.getElementById("steps");
    const resultadoDiv = document.getElementById("result");
    try {
      const pol = parsePolinomio(input);
      let fxhTerms = [];
      let fxTerms = [];

      let pasos = `
        <h2>1. Usamos la definición de derivada:</h2>
        $$f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$
        <h2>2. Expandimos f(x + h):</h2>
      `;

      pol.forEach((t, i) => {
        const expansion = expandBinomio(t.coef, t.exp);
        fxhTerms.push(...expansion);
        let fx = `${t.coef !== 1 ? t.coef : ''}x${t.exp > 1 ? '^' + t.exp : (t.exp === 1 ? '' : '')}`;
        fxTerms.push(fx);
        pasos += `<p>Término ${i+1}: $$${t.coef}(x + h)^${t.exp} = ${expansion.join(' + ')}$$</p>`;
      });

      pasos += `<h2>3. Sustituimos en la fórmula:</h2>`;
      pasos += `$$\\frac{[${fxhTerms.join(' + ')}] - [${fxTerms.join(' + ')}]}{h}$$`;

      // restar fx a fxh
      const restados = fxhTerms.concat(fxTerms.map(t => '-' + t));
      const simplificados = simplificar(restados);

      pasos += `<h2>4. Simplificamos el numerador:</h2>$$${simplificados.join(' + ')}$$`;

      const divididos = simplificados.map(t => `\\frac{${t}}{h}`);
      pasos += `<h2>5. Dividimos todo entre h:</h2>$$${divididos.join(' + ')}$$`;

      const cancelados = divididos.map(t => {
        return t.replace(/\\frac\{(.*?)h(\^\d+)?\}\{h\}/, (_, base, pot) => {
          if (!pot) return base;
          const newPot = parseInt(pot.replace('^', '')) - 1;
          return base + (newPot > 0 ? 'h^' + newPot : '');
        });
      });

      const resultadoFinal = cancelados.filter(t => !t.includes('h')).join(' + ').replace(/\+\s\-/g, '- ');

      pasos += `<h2>6. Aplicamos el límite cuando h → 0:</h2>$$f'(x) = ${resultadoFinal || '0'}$$`;

      pasosDiv.innerHTML = pasos;
      resultadoDiv.innerHTML = `<h2>Resultado Final</h2><p>$$f'(x) = ${resultadoFinal || '0'}$$</p>`;
      MathJax.typeset();
    } catch (e) {
      pasosDiv.innerHTML = 'Error: función no válida. Usa solo polinomios como `x^2 + 2x + 1`.';
      resultadoDiv.innerHTML = '';
    }
  }
</script>
</body>
</html>
